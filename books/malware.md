## Practical Malware Analysis

Michael Sikorski and Andrew Honig

### Chapter 0 - Malware Analysis Primer

The goals of malware analysis

1. Host-based signatures: indicators used to detect malicious code on victim computers.
2. Network signatures: used to detect malicious code by monitoring network traffic.

Malware analysis techniques

1. Static analysis
2. Dynamic analysis

Types of malware

- Backdoor
- Botnet
- Downloader
- Information-stealing malware
- Launcher
- Rootkit
- Scareware
- Spam-sending malware
- Worm or virus

### Chapter 1 - Basic Static Techniques

Techniques

- Antivirus Scanning: http://www.virustotal.com/
- Hashing: see if the file has already been identified
- Strings: get hints about functionality

Packed and obfuscated malware

- Obfuscated programs are ones whose execution the malware author has attempted to hide.
- Packed programs are a subset of obfuscated programs in which the malicious program is compressed and cannot be analyzed.
- Packed and obfuscated code will often include LoadLibrary and GetProcAddress
- Packed programs are run using wrappers that unpack and run the program.
- When doing a static analysis, only the wrapper portion can be analysed.
- You can detect packers using a software called [PEiD](https://www.aldeid.com/wiki/PEiD).
- Many PEiD plug-ins will run the malware executable without warning!

Portable Executable Format

- File format used by Windows executables, object code, and DLLs.
- It is a data structure that contains the information necessary for the Windows OS loader to manage the wrapped executable code.

Linked Libraries and Functions

- Imports are functions used by one program that are actually stored in a different program.
- Code libraries can be connected to the main executable by linking.
- Code libraries can be linked statically, dynamically (program start) or during runtime.

Types of linking

- Static linking is popular in UNIX and linux but not so much in malware.
- Runtime linking is commonly used in malware (packed or obfuscated) these are not listed in file header.
- Dynamic linking is the most common. PE header stores info about libraries and functions to be called.

PE header

- We can see dynamically linked functions using [Dependency Walker](http://www.dependencywalker.com).
- Executables can also import functions by ordinal instead of a name.

Common DLLs

- Kernel32.dll
- Advapi32.dll
- User32.dll
- Gdi32.dll
- Ntdll.dll
- WSock32.dll and Ws2\_32.dl
- Wininet.dll

Function naming conventions

- NewFunction = OldFunction + "Ex"
- FunctionA = ASCII string as parameter
- FunctionW = Wide character string as parameter

Imported and exported functions

- Look into documentation for the Windows API through the Microsoft Developer Network (MSDN) library.
- DLLs and EXEs also export functions. They can be found in the PE file (usually DLLs export not EXEs).

Static analysis in practice

Kernel32.dll

- Manipulate processes: OpenProcess, GetCurrentProcess and GetProcessHeap
- Manipulate files: ReadFile, CreateFile, and WriteFile
- Search through directories: FindFirstFile and FindNextFile

User32.dll

- GUI manipulation: RegisterClassEx, SetWindowText, and ShowWindow
- SetWindowsHookEx: for capturing key strokes (used in spyware).
- RegisterHotKey: a key combination that notifies the application.




